
<mat-toolbar color="primary">

  <span>Order form</span>

  <button mat-icon-button [matMenuTriggerFor]="formMenu">
    <mat-icon>more_vert</mat-icon>
  </button>

  <mat-menu #formMenu="matMenu" xPosition="before" yPosition="below">
    <button mat-menu-item disabled (click)="personalInformation()">Personal information</button>
    <button mat-menu-item (click)="exit()">Re-enter email</button>
    <button mat-menu-item (click)="exit()">Exit</button>
  </mat-menu>

</mat-toolbar>

<div class="content" data-simplebar>

  <mat-vertical-stepper linear="true" (selectionChange)="selectedStep = $event.selectedIndex;process($event)" class="item" #stepper *ngIf="steps[0]"> 

    <!-- step a -->

    <mat-step [stepControl]="formA" *ngIf="steps[1]">
      <form [formGroup]="formA" class="step-a">

        <ng-template matStepLabel>Order</ng-template>

        <div formArrayName="orders" *ngIf="$formA.orders.controls.length > 0">
          <div *ngFor="let order of $formA.orders.controls; let i = index" [formGroupName]="i">

            <mat-form-field appearance="outline" class="order">
              <mat-label>New order</mat-label>
              <mat-select required formControlName="order">
                <mat-option *ngFor="let selection of selections.order_menu" [value]="selection.display" (click)="dynamic.formA.selections[i].state = selection.id === 4">
                  {{ selection.display }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="order-quantity" *ngIf="dynamic?.formA?.selections[i].state">
              <mat-label>Quantity</mat-label>
              <input matInput required type="number" autocomplete="off" formControlName="quantity">
            </mat-form-field>
            <button mat-mini-fab class="order-button" *ngIf="dynamic.formA.selections[i].button && $formA.orders.length === i+1" (click)="addOrder()">
              <mat-icon>add</mat-icon>
            </button>
            <button mat-mini-fab class="order-button" *ngIf="i !== 0" (click)="removeAddedOrder(i)">
              <mat-icon>delete</mat-icon>
            </button>

          </div>
        </div>
        
        <div>
          <button mat-button matStepperNext [disabled]="isNextDisable.formA">Next</button>
        </div>
        
      </form>
    </mat-step>
    
    <!-- step b -->

    <mat-step [stepControl]="formB" *ngIf="steps[2]">
      <form [formGroup]="formB" class="step-b">

        <ng-template matStepLabel>Add-on</ng-template>

        <div class="flavor-content">
          
          <div class="flavor-orders">
            <mat-selection-list [multiple]="false" #selection_list (selectionChange)="log($event)">
              <mat-list-option *ngFor="let control of $formA?.orders.controls; let i = index" [value]="i" (click)="selectedItemName = control?.value?.order">{{ control?.value?.order | orderForm: 'order-name' }}</mat-list-option>
            </mat-selection-list>
          </div>

          <div class="flavor-forms" formArrayName="flavors">
            <div class="flavor-form" *ngFor="let flavor of $formA.flavors.controls; let i = index" [formGroupName]="i">
              <div *ngIf="i === selectedItem">

                <p><strong>Order: {{ selectedItemName | orderForm: 'order-name' }}</strong></p>

                <mat-form-field appearance="outline">
                  <mat-label>Bread</mat-label>
                  <mat-select required formControlName="bread">
                    <mat-option *ngFor="let bread of selections.breads" [value]="bread.display">
                      {{ bread.display }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <br>
                <mat-form-field appearance="outline">
                  <mat-label>Crumbs</mat-label>
                  <mat-select required formControlName="crumbs">
                    <mat-option *ngFor="let crumb of selections.crumbs" [value]="crumb.display">
                      {{ crumb.display }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <br>
                <mat-form-field appearance="outline" *ngIf="!hideFillings">
                  <mat-label>Fillings</mat-label>
                  <mat-select required formControlName="filings" multiple #select>
                    <mat-select-trigger>
                      <span>{{ selections?.filings[0]?.display }}</span>
                      <span *ngIf="select?.value?.length > 1">
                        <span> (+{{ select?.value?.length - 1 }}</span> 
                        <span> {{ select?.value?.length === 2 ? 'other' : 'others' }})</span>
                      </span>
                    </mat-select-trigger>
                    <mat-option *ngFor="let filing of selections?.filings" [value]="filing.id">{{ filing?.display }}</mat-option>
                  </mat-select>
                </mat-form-field>
                <br *ngIf="!hideFillings">
                <mat-form-field appearance="outline">
                  <mat-label>Notes</mat-label>
                  <textarea matInput matTextareaAutosize matAutosize="true" matAutosizeMinRows="5" formControlName="motes" formControlName="notes">
                  </textarea>
                </mat-form-field>
              </div>
            </div>
          </div>

        </div>

         

        <div>
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext [disabled]="isNextDisable.formB">Next</button>
        </div>
        
      </form>
    </mat-step>

    <!-- step c -->
    
    <mat-step [stepControl]="formC" *ngIf="steps[3]">
      <form [formGroup]="formC" class="step-c">

        <ng-template matStepLabel>Update personal information</ng-template>

        <mat-form-field appearance="outline">
          <mat-label>First name</mat-label>
          <input matInput required autocomplete="off" formControlName="fn">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Last name</mat-label>
          <input matInput required autocomplete="off" formControlName="ln">
        </mat-form-field>
        <br>
        <mat-form-field appearance="outline" class="address">
          <mat-label>Address</mat-label>
          <input matInput required autocomplete="off" formControlName="address">
        </mat-form-field>
        <br>
        <mat-form-field appearance="outline">
          <mat-label>Email address</mat-label>
          <input matInput required type="email" autocomplete="off" formControlName="email">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Phone</mat-label>
          <input matInput required type="number" autocomplete="off" type="number" formControlName="phone">
        </mat-form-field>
        <br>
        <mat-form-field appearance="outline" style="width: 350px;">
          <mat-label>Instagram (username)</mat-label>
          <input matInput autocomplete="off" formControlName="instagram">
        </mat-form-field>
        <br>
        <mat-form-field appearance="outline" style="width: 350px;">
          <mat-label>Facebook (email/phone number)</mat-label>
          <input matInput autocomplete="off" formControlName="facebook">
        </mat-form-field>
        <br>
        
        <div>
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext [disabled]="isNextDisable.formC">Next</button>
        </div>

      </form>
    </mat-step>

    <!-- step d -->

    <mat-step [stepControl]="formD" *ngIf="steps[4]">
      <form [formGroup]="formD" class="step-d">

        <ng-template matStepLabel>Service and delivery</ng-template>

        <mat-form-field appearance="outline">
          <mat-label>Services</mat-label>
          <mat-select required formControlName="services">
            <mat-option *ngFor="let selection of selections.services" [value]="selection.display">
              {{ selection.display }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <br>
        <mat-form-field appearance="outline" class="date-picker">
          <mat-label>Choose a date</mat-label>
          <input matInput required [matDatepicker]="picker" formControlName="date">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
        <br>
        <mat-form-field appearance="outline">
          <mat-label>Time</mat-label>
          <mat-select required formControlName="time">
            <mat-option *ngFor="let selection of selections.time" [value]="selection.display">
              {{ selection.display }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div>
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext [disabled]="isNextDisable.formD">Next</button>
          <!-- <button mat-button (click)="submit()">Test Submit</button> -->
        </div>

      </form>
    </mat-step>

    <!-- step e -->

    <mat-step *ngIf="steps[5]">
      <ng-template matStepLabel>Done</ng-template>

      <div class="order-summary">

        <p class="head">Order summary</p>

        <p class="text heading"><strong>Orders:</strong> </p>
        
        <div class="text" *ngFor="let item of form?.orders; let i = index;">
          
          <p class="order">â€¢ {{ item?.order | orderForm: 'order' }} - <em>({{ item | orderForm: 'quantity' }}pcs, ${{ item?.order | orderForm: 'price': (item | orderForm: 'quantity') }})</em>
          </p>
        
          <p class="details">
            <strong>Bread:</strong> {{ i | orderForm: 'details-bread': form?.flavors }} Bread
          </p>
          <p class="details">
            <strong>Crumbs:</strong> {{ i | orderForm: 'details-crumbs': form?.flavors }}
          </p>
          <p class="details" *ngIf="item?.no_filings">
            <strong>Filings:</strong> {{ i | orderForm: 'details-filings': form?.flavors}}
          </p>
          <p class="notes" *ngIf="(i | orderForm: 'details-notes': form?.flavors) !== ''">
            <strong>Notes:</strong> {{ i | orderForm: 'details-notes': form?.flavors }}
          </p>
        
        </div>
        
        <p class="text heading"><strong>Service:</strong> {{ form?.services }}</p>
        <p class="text heading"><strong>Delivery date:</strong> {{ form?.date }} - {{ form?.time }}</p>
        
        <p class="text heading"><strong>Total price:</strong> ${{ form?.price }}.00</p>
        
        <p class="text heading"><strong>Personal Information</strong></p>
        <p class="text"><strong>Name:</strong> {{ form?.fn }} {{ form?.ln }}</p>
        <p class="text"><strong>Instagram:</strong> {{ form?.instagram | orderForm: 'instagram' }}</p>
        <p class="text"><strong>Facebook:</strong> {{ form?.facebook | orderForm: 'facebook' }}</p>
        <p class="text"><strong>Contact:</strong> {{ form?.phone }}</p>
        <p class="text"><strong>Address:</strong> {{ form?.address }} </p>

        <div class="actions">
          <button mat-stroked-button matStepperPrevious>Back</button>
          <button mat-stroked-button (click)="submit()">Submit</button>
        </div>

      </div>

    </mat-step>

  </mat-vertical-stepper>

</div>
